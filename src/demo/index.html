<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSR Demo</title>
    <script src="websr.js" type="application/javascript"></script>
</head>
<body style="background: gray;">

<img id="img" src="test.png" height="512" width="512"  style="display: none;" />
<canvas id="canvas" width="256" height="256" style="display: none;"></canvas>
<canvas id="canvas2" width="512" height="512" style="display: none;"></canvas>
<img id="ref" src="tf-pred.png" height="512" width="512"  style="display: none;" />

<script>

    const workingCanvas = document.getElementById('canvas');
    const destinationCanvas = document.getElementById('canvas2')


    WebSR.initWebGPU().then(async function (gpu) {

        if(!gpu) return console.log("Unable to load WebGPU");

        const weights = await (await fetch('./anime4k-cnn-2x-s-debug.json')).json()

        const websr = new WebSR("anime4k/cnn-2x-s", weights,  gpu, workingCanvas, destinationCanvas);

        console.log("Loaded WebSR", websr);

        const bitmap = await createImageBitmap(document.getElementById('img'));

        console.log("Feeding bitmap into WebSR");

        await websr.loadImage(bitmap);

        console.log("Rendering");

        await websr.render();



        console.log("Loading debug weights");
        const debug_weights = await (await fetch('./anime4k-cnn-2x-s-debug-weights.json')).json()


        delete debug_weights.final;

        console.log("Debug weights");
        console.log(debug_weights);

        for (let layer_name in debug_weights){

        //    console.log(`Running analysis for layer ${layer_name}`);

            const ref_values = debug_weights[layer_name];

            const output_values = await websr.context.readTexture(layer_name);


            let width = layer_name === "pixel_shuffle" ? 512: 256;
            let height= layer_name === "pixel_shuffle" ? 512: 256;
            let channels = layer_name === "pixel_shuffle" ? 1: 4;

            let mse = 0;

            const diff_data = [];
            const ref_data = [];
            const output_data = [];

            for(let k =0; k< channels; k++){
                diff_data.push(new Uint8ClampedArray(width*height*4));
                ref_data.push(new Uint8ClampedArray(width*height*4));
                output_data.push(new Uint8ClampedArray(width*height*4))
            }




            for(let j =0; j < height; j++){
                for(let i=0; i < width; i++){

                    let index = (j*width + i)*channels;

                    for(let k = 0; k < channels; k++){
                        let output_value = output_values[index + k];
                        let ref_value = ref_values[j][i][k];

                        let diff = Math.pow(ref_value-output_value, 2);

                        let debug_index = (j*width + i)*4;


                        diff_data[k].fill(Math.round(diff*255), debug_index, debug_index+3 );
                        diff_data[k][debug_index + 3] = 255;

                        output_data[k].fill(Math.abs(Math.round(output_value*255)), debug_index, debug_index+3 );
                        output_data[k][debug_index + 3] = 255;

                        ref_data[k].fill((Math.abs(Math.round(ref_value*255))), debug_index, debug_index+3 );
                        ref_data[k][debug_index + 3] = 255;

                        mse += diff;
                    }

                }
            }


            const debug_data = [ref_data, output_data, diff_data];
            const names = ['Reference',  'Output', 'Difference']


            const div = document.createElement('div');
            div.style.float = "none";
            div.style.width = `${width*channels}px`;



            const node = document.createElement('Div');
            node.style.width = `${width*channels}px`;
            node.innerText  = `Layer ${layer_name}`;
            node.style.fontWeight= 'bold';
            node.style.fontSize = '20px';

            div.appendChild(node);

            for(let l = 0; l < debug_data.length; l++){



                const node2 = document.createElement('Div');
                node2.style.width = `${width*channels}px`;
                node2.innerText  = `${names[l]} maps`;
                div.appendChild(node2);



                for (let k = 0; k< channels; k++){
                    const data = debug_data[l][k];

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    canvas.style.float = "left";
                    const ctx = canvas.getContext('2d');

                    const image_data = new ImageData(data, width, height);

                    console.log("Putting image data");

                    ctx.putImageData(image_data, 0, 0);

                    div.appendChild(canvas);

                }

                document.body.appendChild(div);


            }








            console.log(`MSE for layer ${layer_name}: ${mse}`);
        }









    });


</script>


</body>
</html>