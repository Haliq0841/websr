<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSR Demo</title>
    <script src="websr.js" type="application/javascript"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap-theme.min.css" integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">
</head>
<body style="margin-left: 10px;">

<h2>
    WebSR Inference Test <br>
    <small>Anime4K CNN Small 2X Upscaling Network</small>
</h2>
<br>

<div class="alert alert-danger" role="alert" style="display: none" id="webgpu-not-supported">
    Web GPU wasn't able to load. Sorry!
</div>

<div class="row">
    <div class="col-md-4">
        <h4>Input</h4>
        <img id="img" src="test.png" height="512" width="512"  />

    </div>

</div>


<div class="row">
    <div class="col-md-5">

        <h4>Output</h4>
        <canvas id="canvas2" width="512" height="512" ></canvas>

    </div>
    <div class="col-md-5">
        <h4>Reference</h4>
        <img id="ref" src="tf-pred.png" height="512" width="512"  />
    </div>
</div>


<div class="row">
    <div class="col-md-5">

        <h3>Layers</h3>


    </div>

</div>


<canvas id="canvas" width="256" height="256" style="display: none;"></canvas>



<script>

    const workingCanvas = document.getElementById('canvas');
    const destinationCanvas = document.getElementById('canvas2')


    WebSR.initWebGPU().then(async function (gpu) {

        if(!gpu) {
            document.getElementById('webgpu-not-supported').style.display = 'block';
            return console.log("Unable to load WebGPU");
        }

        const weights = await (await fetch('./anime4k-cnn-2x-s-debug.json')).json()

        const websr = new WebSR("anime4k/cnn-2x-s", weights,  gpu, workingCanvas, destinationCanvas);

        console.log("Loaded WebSR", websr);

        const bitmap = await createImageBitmap(document.getElementById('img'));

        console.log("Feeding bitmap into WebSR");

        await websr.loadImage(bitmap);

        console.log("Rendering");

        await websr.render();



        console.log("Loading debug weights");
        const debug_weights = await (await fetch('./anime4k-cnn-2x-s-debug-weights.json')).json()


        delete debug_weights.final;

        console.log("Debug weights");
        console.log(debug_weights);

        for (let layer_name in debug_weights){


            const ref_values = debug_weights[layer_name];

            const output_values = await websr.context.readTexture(layer_name);


            let width = layer_name === "pixel_shuffle" ? 512: 256;
            let height= layer_name === "pixel_shuffle" ? 512: 256;
            let channels = layer_name === "pixel_shuffle" ? 1: 4;

            let mse = 0;

            const diff_data = [];
            const ref_data = [];
            const output_data = [];

            for(let k =0; k< channels; k++){
                diff_data.push(new Uint8ClampedArray(width*height*4));
                ref_data.push(new Uint8ClampedArray(width*height*4));
                output_data.push(new Uint8ClampedArray(width*height*4))
            }


            const border_buffer = 10; //


            for(let j =0; j < height; j++){
                for(let i=0; i < width; i++){

                    let index = (j*width + i)*channels;

                    for(let k = 0; k < channels; k++){
                        let output_value = output_values[index + k];
                        let ref_value = ref_values[j][i][k];

                        let diff = Math.pow(ref_value-output_value, 2);

                        let debug_index = (j*width + i)*4;


                        diff_data[k].fill(Math.round(diff*255), debug_index, debug_index+3 );
                        diff_data[k][debug_index + 3] = 255;

                        output_data[k].fill(Math.abs(Math.round(output_value*255)), debug_index, debug_index+3 );
                        output_data[k][debug_index + 3] = 255;

                        ref_data[k].fill((Math.abs(Math.round(ref_value*255))), debug_index, debug_index+3 );
                        ref_data[k][debug_index + 3] = 255;

                        // Because we're not doing padding, the edges in real world use cases diverge from the original
                        // In this case, we don't care about the edges of the frame, so we don't count them as error
                        if(j > border_buffer && j < (height-border_buffer) && i > border_buffer && i < (width-border_buffer)){
                            mse += diff;
                        }


                    }

                }
            }


            const debug_data = [ref_data, output_data, diff_data];
            const names = ['Reference',  'Output', 'Difference']

            document.body.appendChild(document.createElement('br'));


            const node = document.createElement('h4');
            node.style.width = `${width*channels}px`;
            node.innerHTML  = `Layer <em>${layer_name}</em> &nbsp; <small>${mse<1? "✅" : "❌"}</small> <br> <small>MSE: ${Math.round(mse*100)/100}</small>`;


            document.body.appendChild(node);

            for(let l = 0; l < debug_data.length; l++){



                const node2 = document.createElement('h3');
                node2.style.width = `${width*channels}px`;
                node2.innerHTML  = `<small>${names[l]} maps</small>`;
                document.body.appendChild(node2);



                for (let k = 0; k< channels; k++){
                    const data = debug_data[l][k];

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.style.marginBottom = "10px";
                    canvas.height = height;
                    canvas.style.float = "left";
                    const ctx = canvas.getContext('2d');

                    const image_data = new ImageData(data, width, height);

                    console.log("Putting image data");

                    ctx.putImageData(image_data, 0, 0);

                    document.body.appendChild(canvas);

                }

                //document.body.appendChild(div);

            }

            document.body.appendChild(document.createElement('br'));








            console.log(`MSE for layer ${layer_name}: ${mse}`);
        }









    });


</script>


</body>
</html>