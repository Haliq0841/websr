<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSR Demo</title>
    <script src="websr.js" type="application/javascript"></script>
</head>
<body style="background: gray;">

<img id="img" src="test.png" height="512" width="512"  />
<canvas id="canvas" width="256" height="256" style="display: none;"></canvas>
<canvas id="canvas2" width="512" height="512"></canvas>
<img id="ref" src="tf-pred.png" height="512" width="512"  />

<script>

    const workingCanvas = document.getElementById('canvas');
    const destinationCanvas = document.getElementById('canvas2')


    WebSR.initWebGPU().then(async function (gpu) {

        if(!gpu) return console.log("Unable to load WebGPU");

        const weights = await (await fetch('./anime4k-cnn-2x-s-debug.json')).json()

        const websr = new WebSR("anime4k/cnn-2x-s", weights,  gpu, workingCanvas, destinationCanvas);

        console.log("Loaded WebSR", websr);

        const bitmap = await createImageBitmap(document.getElementById('img'));

        console.log("Feeding bitmap into WebSR");

        await websr.loadImage(bitmap);

        console.log("Rendering");

        await websr.render();



        console.log("Loading debug weights");
        const debug_weights = await (await fetch('./anime4k-cnn-2x-s-debug-weights.json')).json()


        delete debug_weights.final;

        console.log("Debug weights");
        console.log(debug_weights);

        for (let layer_name in debug_weights){

            console.log(`Running analysis for layer ${layer_name}`);

            const ref_values = debug_weights[layer_name];

            const output_values = await websr.context.readTexture(layer_name);


            let width = layer_name === "pixel_shuffle" ? 512: 256;
            let height= layer_name === "pixel_shuffle" ? 512: 256;

            let samples = 0;
            let mse = 0;


            for(let j =0; j < height; j++){
                for(let i=0; i < width; i++){

                    samples++;

                    if(layer_name === 'pixel_shuffle'){
                        let output_value = output_values[j*width + i];
                        let ref_value = ref_values[j][i][0];

                        mse += Math.pow(ref_value-output_value, 2);

                       //
                    } else {

                        let index = (j*width + i)*4;
                        for(let k = 0; k < 4; k++){
                            let output_value = output_values[index + k];
                            let ref_value = ref_values[j][i][k];

                            mse += Math.pow(ref_value-output_value, 2);
                        }



                    }



                }
            }


        }









    });


</script>


</body>
</html>