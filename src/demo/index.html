<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSR Demo</title>
    <script src="websr.js" type="application/javascript"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap-theme.min.css" integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">
    <script src="image-compare-viewer.min.js"></script>
    <link href="image-compare-viewer.min.css" rel="stylesheet">
</head>
<body style="margin-left: 10px;">

<h2>
    WebSR Demo <br>
    <small>Anime4K CNN Small 2X Upscaling Network</small>
</h2>
<br>

<div class="alert alert-danger" role="alert" style="display: none" id="webgpu-not-supported">
    Web GPU wasn't able to load. Sorry!
</div>


<div id="image-compare">
    <video id="video" slot="first" src="hero.webm" height="720" width="1280"  muted autoplay loop ></video>
    <canvas id="canvas" slot="second" width="1280" height="720" ></canvas>
</div>


<div class="row">
    <div class="col-md-4">
        <h4>Input</h4>

    </div>

</div>


<div class="row">
    <div class="col-md-5">

        <h4>Output</h4>

    </div>
</div>


<div class="row">
    <div class="col-md-5">

        <h3>Layers</h3>


    </div>

</div>




<script>

    let showUpscaled = true;


    const canvas = document.getElementById('canvas');

    WebSR.initWebGPU().then(async function (gpu) {

        if(!gpu) {
            document.getElementById('webgpu-not-supported').style.display = 'block';
            return console.log("Unable to load WebGPU");
        }


        const video = document.getElementById('video');

        await new Promise(function (resolve, reject) {

            if(video.readyState > 2) return resolve();

            video.oncanplay = function () {
                resolve();
            }
        });

        video.currentTime = 3;


        await new Promise(function (resolve, reject) {
            setTimeout(resolve, 100);
        });



        const weights = await (await fetch('./anime4k-cnn-2x-s.json')).json()

        const websr = new WebSR("anime4k/cnn-2x-s", weights,  gpu, canvas);

        console.log("Loaded WebSR", websr);

        const bitmap = await createImageBitmap(video);

        console.log("Feeding bitmap into WebSR");

        await websr.loadImage(bitmap);

        console.log("Rendering");

        await websr.render();

        video.pause();


        const element = document.getElementById("image-compare");

        const viewer = new ImageCompare(element).mount();


        window.toggle = function () {

            if(showUpscaled) {
                canvas.style.display = "none";
                video.style.display = "block";
            } else {
                video.style.display = "none";
                canvas.style.display = "block";
            }

            showUpscaled = !showUpscaled;
        }

    });



</script>


</body>
</html>